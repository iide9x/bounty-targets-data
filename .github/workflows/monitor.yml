name: Monitor New Domains

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Restore cache
        uses: actions/cache@v3
        with:
          path: old.txt
          key: domains-${{ github.run_number }}
          restore-keys: domains-
          
      - name: Check for new domains
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Fetch current data
          curl -sf https://raw.githubusercontent.com/arkadiyt/bounty-targets-data/main/domains.txt -o new.txt
          curl -sf https://raw.githubusercontent.com/arkadiyt/bounty-targets-data/main/wildcards.txt >> new.txt
          
          # Compare if old exists
          if [ -f old.txt ]; then
            comm -13 <(sort -u old.txt) <(sort -u new.txt) > diff.txt
            
            if [ -s diff.txt ]; then
              COUNT=$(wc -l < diff.txt)
              
              # Send summary
              curl -sf "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
                -d "chat_id=${TG_CHAT}" \
                -d "text=ðŸŽ¯ Found $COUNT new domains!" \
                -d "parse_mode=HTML" >/dev/null
              
              # Send domains (batched to avoid rate limits)
              cat diff.txt | head -50 | while read domain; do
                curl -sf "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
                  -d "chat_id=${TG_CHAT}" \
                  -d "text=ðŸ†• <code>$domain</code>" \
                  -d "parse_mode=HTML" >/dev/null
                sleep 0.05
              done
              
              # If more than 50, send file
              if [ $COUNT -gt 50 ]; then
                curl -sf "https://api.telegram.org/bot${TG_TOKEN}/sendDocument" \
                  -F "chat_id=${TG_CHAT}" \
                  -F "document=@diff.txt" \
                  -F "caption=ðŸ“„ All $COUNT new domains" >/dev/null
              fi
              
              echo "âœ… Sent $COUNT new domains to Telegram"
            else
              echo "No new domains found"
            fi
          else
            echo "First run - caching $(wc -l < new.txt) domains"
          fi
          
          # Update cache
          mv new.txt old.txt
